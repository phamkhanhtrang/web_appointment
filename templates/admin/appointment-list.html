{% load static %}
{% include "admin/dashboard.html" %}
{% block content %}
<div class="page-wrapper">
	<div class="content container-fluid">
		<div class="container py-4">
			<div class="sticky-header text-center fade-in">
				<h1 class="fw-bold mb-1" style="letter-spacing:1px;">üìä Th·ªëng k√™ c√°c cu·ªôc h·∫πn</h1>
				<p class="text-muted mb-0">T·ªïng quan ho·∫°t ƒë·ªông, l·ªãch h·∫πn trong h·ªá th·ªëng.</p>
			</div>
			<div class="row g-4 mb-4 fade-in">
				<div class="col-md-5">
					<div class="glass-card p-4 d-flex align-items-center">
						<span class="stat-icon"><i class="bi bi-person-badge"></i></span>
						<div>
							<div class="small text-muted">T·ªïng s·ªë cu·ªôc h·∫πn th√†nh c√¥ng</div>
							<div class="fs-3 fw-bold">{{ admin_total_appointments }}</div>
						</div>
					</div>
				</div>

				<div class="col-md-5">
					<div class="glass-card p-4 d-flex align-items-center">
						<span class="stat-icon"><i class="bi bi-calendar-check"></i></span>
						<div>
							<div class="small text-muted">T·ªïng doanh thu l·ªãch h·∫πn</div>
							<div class="fs-3 fw-bold">{{admin_total_revenue_vnd}}</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Page Header -->

		<div class="chart-card mb-5 fade-in">
			<h6 class="fw-bold mb-3">üìã Danh s√°ch cu·ªôc h·∫πn</h6>
			<div class="table-responsive">
				<table class="datatable table table-hover align-middle table-center mb-0">
					<thead class="table-light">
						<tr>
							<th class="text-center">STT</th>
							<th style="width:60px;">B√°c sƒ©</th>
							<th class="text-center">T√™n b·ªánh nh√¢n</th>
							<th class="text-center">Th·ªùi gian </th>
							<th class="text-center">Tr·∫°ng th√°i</th>
							<th class="text-center">S·ªë ti·ªÅn h·∫πn</th>
						</tr>
					</thead>
					<tbody>
						{% for appointment in admin_list_appointment %}
						<tr>
							<td>{{ forloop.counter }}</td>
							<td>
								<!-- <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="avatar"
									class="rounded-circle me-2" width="36"> -->
								<span class="fw-bold">BS. {{ appointment.doctor.user.get_full_name}}</span>
							</td>
							<td><span class="fw-bold">{{ appointment.patient.user.get_full_name}}</span></td>
							<td class="text-center">{{ appointment.appointment_time| date:"H:i d/m/y" }}</td>
							<td>
								<div class="status-toggle">
									<form method="post">
										{% csrf_token %}
										<input type="hidden" name="appointment_id" value="{{ appointment.id }}">
										<select name="status" class="form-select" onchange="this.form.submit()">
											<option value="pending" {% if appointment.status == "pending" %}selected{% endif %}>Ch·ªù b·∫°n/b√°c sƒ© x√°c nh·∫≠n</option>
											<option value="confirmed" {% if appointment.status == 'confirmed' %}selected{% endif %}> B·∫°n/ B√°c sƒ© ƒë√£ x√°c nh·∫≠n</option>
											<option value="completed" {% if appointment.status == 'completed' %}selected{% endif %}>Ho√†n th√†nh</option>
											<option value="cancelled" {% if appointment.status == 'cancelled' %}selected{% endif %}>B·ªã h·ªßy</option>

										</select>
									</form>
								</div>
							</td>
							<td class="text-right">{{appointment.price_vnd}}
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
		<h2>ch·ªçn ng√†y xem bi·ªÉu ƒë·ªì</h2>
		<div class="row g-4">
			<div class="d-flex mb-3">
				<input type="date" id="startDate" class="form-control me-2">
				<input type="date" id="endDate" class="form-control">
				<button type="button" class="btn btn-primary" onclick="filterChart()">L·ªçc</button>
				<button type="button" class="btn btn-primary" onclick="exportExcel()">Xu·∫•t file excel</button>
			</div>
			<!-- Bi·ªÉu ƒë·ªì c·ªôt: L·ªãch h·∫πn theo tr·∫°ng th√°i -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title text-center">S·ªë l∆∞·ª£ng cu·ªôc h·∫πn theo ng√†y</h5>
						<canvas id="appointmentChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Bi·ªÉu ƒë·ªì tr√≤n: B·ªánh nh√¢n m·ªõi / quay l·∫°i -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title text-center">T·ªâ l·ªá tr·∫°ng th√°i c·ªßa l·ªãch h·∫πn</h5>
						<canvas id="statusChart"></canvas>

					</div>
				</div>
			</div>
		</div>



	</div>
</div>
<!-- /Page Wrapper -->
<script>
	$('.datatable').DataTable();

	const chartData = JSON.parse('{{ admin_chart_data|safe }}');

	const today = new Date()
	const lastweek = new Date()
	lastweek.setDate(today.getDate() - 6)

	const getDateStr = (d) => d.toISOString().slice(0, 10);

	function buildChartData(days,sourceData ) {
		const filteredData = days.map(d => {
			const found = sourceData.find(item => item.day == d);
			return found ? found : { day: d, appointments: 0, pending: 0, confirmed: 0, completed: 0, cancelled: 0 };
		});
		return {
			labels: filteredData.map(item => item.day),
			totalAppointments: filteredData.map(item => item.appointments),
			statusCounts: {
				pending: filteredData.map(item => item.pending),
				confirmed: filteredData.map(item => item.confirmed),
				completed: filteredData.map(item => item.completed),
				cancelled: filteredData.map(item => item.cancelled),
			}
		};
	}

	const filteredDays = [];
	for (let d = new Date(lastweek); d <= today; d.setDate(d.getDate() + 1)) {
		filteredDays.push(getDateStr(new Date(d)));
	}

	let {labels, totalAppointments, statusCounts} = buildChartData(filteredDays,chartData)

	const appointmentChart = new Chart(document.getElementById('appointmentChart'), {
		type: "line",
		data: {
			labels: labels,
			datasets: [{
				label: "T·ªïng s·ªë cu·ªôc h·∫πn",
				data: totalAppointments,
				borderColor: 'rgba(75, 192, 192, 1)',
				backgroundColor: "rgba(75, 192, 192, 0.2)",
				fill: true
			}]
		}, options: { responsive: true }
	});
	const statusChart = new Chart(
		document.getElementById('statusChart').getContext('2d'), {
		type: "bar",
		data: {
			labels: labels,
			datasets: [
				{ label: "ƒêang ch·ªù", data: statusCounts.pending, backgroundColor: "#ffc107" },
				{ label: "ƒê√£ x√°c nh·∫≠n", data: statusCounts.confirmed, backgroundColor: "#17a2b8" },
				{ label: "Ho√£n th√†nh", data: statusCounts.completed, backgroundColor: "#28a745" },
				{ label: "ƒê√£ h·ªßy", data: statusCounts.cancelled, backgroundColor: "#dc3545" },
			]
		}
	});

	function filterChart() {
		const startDate = document.getElementById('startDate').value;
		const endDate = document.getElementById('endDate').value;
		if (!startDate || !endDate) {
			alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c");
			return;
		}
		const filteredDays = chartData
			.map(item => item.day)
			.filter(dayStr => dayStr >= startDate && dayStr <= endDate)
			.sort();
		
     let {labels, totalAppointments, statusCounts} = buildChartData(filteredDays,chartData)
		// --- C·∫≠p nh·∫≠t line chart (t·ªïng cu·ªôc h·∫πn) ---
		appointmentChart.data.labels = labels;
		appointmentChart.data.datasets[0].data = totalAppointments;
		appointmentChart.update();

		// --- C·∫≠p nh·∫≠t bar chart (theo tr·∫°ng th√°i) ---
		statusChart.data.labels = labels;
		statusChart.data.datasets[0].data = statusCounts.pending;
		statusChart.data.datasets[1].data = statusCounts.confirmed;
		statusChart.data.datasets[2].data = statusCounts.completed;
		statusChart.data.datasets[3].data = statusCounts.cancelled;
		statusChart.update();

		// console.log("Filtered:", filteredData);

	}

function exportExcel() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end) {
    alert("Vui l√≤ng ch·ªçn ng√†y!");
    return;
  }
  window.location.href = `?start=${start}&end=${end}&export=1`;
}



</script>
{%endblock%}