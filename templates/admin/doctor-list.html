{% load static %}
{% include "admin/dashboard.html" %}
{% block content %}

<div class="page-wrapper">
	<div class="content container-fluid">
		<div class="container py-4">
			<div class="sticky-header text-center fade-in">
				<h1 class="fw-bold mb-1" style="letter-spacing:1px;">📊 Thống kê Bác sĩ</h1>
				<p class="text-muted mb-0">Tổng quan hoạt động, lịch hẹn của các bác sĩ trong hệ thống.</p>
			</div>

			<!-- Cards tổng quan -->
			<div class="row g-4 mb-4 fade-in">
				<div class="col-md-5">
					<div class="glass-card p-4 d-flex align-items-center">
						<span class="stat-icon"><i class="bi bi-person-badge"></i></span>
						<div>
							<div class="small text-muted">Tổng số bác sĩ</div>
							<div class="fs-3 fw-bold">{{admin_total_doctors}}</div>
						</div>
					</div>
				</div>
				<div class="col-md-5">
					<div class="glass-card p-4 d-flex align-items-center">
						<span class="stat-icon"><i class="bi bi-calendar-check"></i></span>
						<div>
							<div class="small text-muted">Tổng lịch hẹn</div>
							<div class="fs-3 fw-bold">{{admin_total_appointments}}</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Biểu đồ -->
			<div class="row g-4 mb-4 fade-in">
				<div class="col-md-10">
					<div class="chart-card">
						<h6 class="fw-bold mb-3">📊 So sánh lịch hẹn theo bác sĩ</h6>
						<div class="d-flex mb-3">
							<input type="date" id="startDate" class="form-control me-2">
							<input type="date" id="endDate" class="form-control">
							<button class="bt btn-primary" onclick="filterChart()">Lọc</button>
						</div>
						<canvas id="doctorBarChart" height="120"></canvas>
					</div>
				</div>
				<!-- <div class="col-md-6">
					<div class="chart-card">
						<h6 class="fw-bold mb-3">📈 Lịch hẹn theo ngày</h6>

						<div class="d-flex mb-3">
							<input type="date" id="lineStartDate" class="form-control me-2">
							<input type="date" id="lineEndDate" class="form-control me-2">
							<button class="btn btn-primary" onclick="filterLineChart()">Lọc</button>
						</div>
						<canvas id="appointmentLineChart" height="120"></canvas>
					</div>

				</div> -->
			</div>

			<!-- Bảng chi tiết -->
			<div class="chart-card mb-5 fade-in">
				<h6 class="fw-bold mb-3">📋 Thống kê chi tiết từng bác sĩ</h6>
				<div class="table-responsive">
					<table class="table table-hover align-middle">
						<thead class="table-light">
							<tr>
								<th style="width:60px;">Bác sĩ</th>
								<th>Chuyên khám</th>
								<th class="text-center">Giá khám bệnh</th>
								<th class="text-center">SĐT</th>
								<th class="text-center">Lịch làm việc</th>
								<th class="text-center">Thống kê</th>
							</tr>
						</thead>
						<tbody>
							{% for list_doctor in admin_list_doctor %}
							<tr>
								<td>
									<img src="{{list_doctor.user.avatar.url}}" alt="avatar"
										class="rounded-circle me-2" width="36">
									<span class="fw-bold">BS.{{ list_doctor.user.get_full_name }}</span>
								</td>
								<td><span class="badge bg-primary">{{ list_doctor.specialization }}</span></td>
								<td class="text-center">{{list_doctor.price_vnd}}</td>
								<td class="text-center">{{ list_doctor.user.phone_number }}</td>
								<td class="text-center"><a href="admin-calendar/{{ list_doctor.user.username }}">Xem
										lịch</a></td>
								<td class="text-center">Xem thống kê</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Floating Export Button -->
		<div class="fab" title="Xuất báo cáo">
			<i class="bi bi-download"></i>
		</div>
	</div>
</div>
<script>
	// Biểu đồ cột
	const appointmentData = JSON.parse('{{ admin_chart_data|escapejs }}');   // lấy từ Django context

	const barCtx = document.getElementById("doctorBarChart").getContext("2d");

	// Lấy danh sách bác sĩ duy nhất
	const doctors = [...new Set(appointmentData.map(item => item.doctor))];

	let doctorChart = new Chart(barCtx, {
		type: "bar",
		data: {
			labels: doctors,
			datasets: [{
				label: "Số lịch hẹn",
				data: doctors.map(doc =>
					appointmentData.filter(item => item.doctor === doc)
						.reduce((sum, item) => sum + item.appointments, 0)
				),
				backgroundColor: ["#42a5f5", "#66bb6a", "#ffa726", "#ef5350"]
			}]
		},
		options: {
			responsive: true,
			scales: {
				y: { beginAtZero: true }
			}
		}
	});

	// Lọc theo ngày
	function filterChart() {
		const startDate = document.getElementById("startDate").value;
		const endDate = document.getElementById("endDate").value;

		if (!startDate || !endDate) {
			alert("Vui lòng chọn cả ngày bắt đầu và ngày kết thúc.");
			return;
		}

		let counts = doctors.map(doc => {
			return appointmentData
				.filter(item => item.doctor === doc && item.day >= startDate && item.day <= endDate)
				.reduce((sum, item) => sum + item.appointments, 0);
		});

		doctorChart.data.datasets[0].data = counts;
		doctorChart.update();
	}
	// Biểu đồ đường
	// const lineCtx = document.getElementById("appointmentLineChart").getContext("2d");

	// // Dữ liệu giả lập theo ngày
	// const lineDataRaw = [
	// 	{ date: "2025-07-01", count: 10 },
	// 	{ date: "2025-07-02", count: 12 },
	// 	{ date: "2025-07-03", count: 14 },
	// 	// ... có thể generate đầy đủ 31 ngày tháng 7
	// 	{ date: "2025-08-01", count: 20 },
	// 	{ date: "2025-08-02", count: 18 },
	// 	{ date: "2025-08-03", count: 25 },
	// 	{ date: "2025-08-04", count: 22 },
	// 	{ date: "2025-08-05", count: 28 },
	// 	{ date: "2025-08-06", count: 26 },
	// 	{ date: "2025-08-07", count: 30 },
	// 	{ date: "2025-08-08", count: 32 },
	// 	{ date: "2025-08-09", count: 27 },
	// 	{ date: "2025-08-10", count: 29 },
	// 	{ date: "2025-08-11", count: 31 },
	// 	{ date: "2025-08-12", count: 33 },
	// 	{ date: "2025-08-13", count: 35 },
	// 	{ date: "2025-08-14", count: 28 },
	// 	{ date: "2025-09-01", count: 2 },
	// 	{ date: "2025-09-10", count: 30 },
	// 	{ date: "2025-09-11", count: 130 },
	// ];
	// const today = new Date();
	// const startDate = new Date();
	// startDate.setDate(today.getDate() - 13);

	// const formatDate = (d) => d.toISOString().split('T')[0];
	// const startStr = formatDate(startDate);
	// const endStr = formatDate(today);
	// const defaultData = lineDataRaw.filter(item => item.date >= startStr && item.date <= endStr);
	// // Khởi tạo chart mặc định
	// let lineChart = new Chart(lineCtx, {
	// 	type: "line",
	// 	data: {
	// 		labels: defaultData.map(item =>
	// 			new Date(item.date).toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit" })
	// 		),
	// 		datasets: [{
	// 			label: "Số lịch hẹn",
	// 			data: defaultData.map(item => item.count),
	// 			borderColor: "#66bb6a",
	// 			backgroundColor: "rgba(102,187,106,0.1)",
	// 			tension: 0.3,
	// 			fill: true,
	// 			pointRadius: 5,
	// 			pointBackgroundColor: "#66bb6a"
	// 		}]
	// 	},
	// 	options: { responsive: true }
	// });

	// // Hàm lọc dữ liệu theo khoảng ngày
	// function filterLineChart() {
	// 	const start = document.getElementById("lineStartDate").value;
	// 	const end = document.getElementById("lineEndDate").value;

	// 	if (!start || !end) {
	// 		alert("Vui lòng chọn khoảng thời gian!");
	// 		return;
	// 	}

	// 	// Lọc dữ liệu trong khoảng start-end
	// 	const filtered = lineDataRaw.filter(item => item.date >= start && item.date <= end);
	// 	if (filtered.length === 0) {
	// 		alert("Không có dữ liệu trong khoảng ngày đã chọn.");
	// 		return;
	// 	}
	// 	// Cập nhật chart
	// 	lineChart.data.labels = filtered.map(item =>
	// 		new Date(item.date).toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit" })
	// 	);
	// 	lineChart.data.datasets[0].data = filtered.map(item => item.count);
	// 	lineChart.update();
	// }

	// Export button (demo)
	document.querySelector('.fab').onclick = function () {
		alert('Chức năng xuất báo cáo sẽ được phát triển!');
	};
</script>
{%endblock%}