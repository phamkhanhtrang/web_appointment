{% load static %}
{% include "admin/dashboard.html" %}
{% block content %}

<div class="page-wrapper">
	<div class="content container-fluid">
		<div class="container py-4">
			<div class="sticky-header text-center fade-in">
				<h1 class="fw-bold mb-1" style="letter-spacing:1px;">üìä Th·ªëng k√™ c√°c b·ªánh nh√¢n</h1>
				<p class="text-muted mb-0">T·ªïng quan l·ªãch s·ª≠ b·ªánh nh√¢n c·ªßa h·ªá th·ªëng.</p>
			</div>
		</div>

		<!-- Page Header -->

		<div class="chart-card mb-5 fade-in">
			<h6 class="fw-bold mb-3">üìã Danh s√°ch b·ªánh nh√¢n</h6>
			<div class="table-responsive">
				<table class="datatable table table-hover align-middle table-center mb-0">
					<thead class="table-light">
						<tr>
							<th class="text-center">STT</th>
							<th style="width:60px;">T√™n b·ªánh nh√¢n</th>
							<th class="text-center">S·ªë l·∫ßn t√°i kh√°m</th>
							<th class="text-center">SƒêT </th>
							<th class="text-center">L·∫ßn kh√°m g·∫ßn nh·∫•t</th>

						</tr>
					</thead>
					<tbody>
						{% for patient in admin_list_patient %}
						<tr>
							<td>{{ forloop.counter }}</td>
							<td>
								<h2 class="table-avatar">

									<a>{{ patient.user__first_name }} {{ patient.user__last_name }}</a>
								</h2>
							</td>
							<td>{{ patient.total }}</td>
							<td>{{ patient.user__phone_number }}</td>
							<td>
								{% if patient.last_visit_date %}
								{{ patient.last_visit_date|date:"d/m/Y" }}
								{% else %}
								Ch∆∞a c√≥ l·∫ßn kh√°m n√†o
								{% endif %}
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
		<h2>ch·ªçn ng√†y xem bi·ªÉu ƒë·ªì</h2>
		<div class="row g-4">
			<div class="d-flex mb-3">
				<input type="date" id="startDate" class="form-control me-2">
				<input type="date" id="endDate" class="form-control">
				<button type="button" class="btn btn-primary" onclick="filterChart()">L·ªçc</button>
				<button type="button" class="btn btn-primary" onclick="exportExcel()">Xu·∫•t file excel</button>
			</div>
			<!-- Bi·ªÉu ƒë·ªì c·ªôt: L·ªãch h·∫πn theo tr·∫°ng th√°i -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title text-center">T·ªïng S·ªë l∆∞·ª£ng b·ªánh nh√¢n ƒë·∫∑t l·ªãch</h5>
						<canvas id="patientChart"></canvas>
					</div>
				</div>
			</div>

			<!-- Bi·ªÉu ƒë·ªì tr√≤n: B·ªánh nh√¢n m·ªõi / quay l·∫°i -->
			<div class="col-md-6">
				<div class="card shadow-sm">
					<div class="card-body">
						<h5 class="card-title text-center">S·ªë l∆∞·ª£ng b·ªánh nh√¢n m·ªõi vs quay l·∫°i</h5>
						<canvas id="patientPieChart"></canvas>

					</div>
				</div>
			</div>
		</div>



	</div>
</div>
<script>
const chartData = JSON.parse('{{ admin_chart_data|safe }}');

const today = new Date();
const lastWeek = new Date();
lastWeek.setDate(today.getDate() - 6);

const getDateStr = (d) => d.toISOString().slice(0, 10);
const filteredDays = [];
for (let d = new Date(lastWeek); d <= today; d.setDate(d.getDate() + 1)) {
	filteredDays.push(getDateStr(new Date(d)));
}

// ---- Line chart: b·ªánh nh√¢n theo ng√†y ----
const patient = filteredDays.map(d => {
	const found = chartData.find(item => item.day === d);
	return found ? found.patients : 0;
});
const ctx1 = document.getElementById('patientChart').getContext('2d');
patientChart = new Chart(ctx1, {
	type: 'line',
	data: {
		labels: filteredDays,
		datasets: [{
			label: 'S·ªë l∆∞·ª£ng b·ªánh nh√¢n',
			data: patient,
			backgroundColor: 'rgba(255, 206, 86, 0.3)',
			borderColor: 'rgba(255, 206, 86, 1)',
			fill: true
		}]
	},
	options: { responsive: true }
});

// ---- Pie chart: b·ªánh nh√¢n m·ªõi vs quay l·∫°i ----
let totalNew = 0;
let totalReturning = 0;
chartData.forEach(item => {
	totalNew += item.new_patients;
	totalReturning += item.returning_patients;
});

const ctx2 = document.getElementById('patientPieChart').getContext('2d');
new Chart(ctx2, {
	type: 'pie',
	data: {
		labels: ['B·ªánh nh√¢n m·ªõi', 'B·ªánh nh√¢n quay l·∫°i'],
		datasets: [{
			data: [totalNew, totalReturning],
			backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
			borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
			borderWidth: 1
		}]
	},
	options: {
		responsive: true,
		plugins: {
			legend: {
				position: 'bottom'
			}
		}
	}
});
function filterChart() {
	const startDate = document.getElementById('startDate').value;
	const endDate = document.getElementById('endDate').value;
	if (!startDate || !endDate) {
		alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c");
		return;
	}

	// --- L·ªçc d·ªØ li·ªáu theo kho·∫£ng ng√†y ---
	const filteredData = chartData
		.filter(item => item.day >= startDate && item.day <= endDate)
		.sort((a, b) => a.day.localeCompare(b.day));

	if (filteredData.length === 0) {
		alert("Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian n√†y");
		return;
	}

	// --- Line chart (b·ªánh nh√¢n theo ng√†y) ---
	const labels = filteredData.map(item => item.day);
	const totalPatients = filteredData.map(item => item.patients);

	patientChart.data.labels = labels;
	patientChart.data.datasets[0].data = totalPatients;
	patientChart.update();

	// --- Pie chart (b·ªánh nh√¢n m·ªõi vs quay l·∫°i) ---
	let totalNew = 0;
	let totalReturning = 0;
	filteredData.forEach(item => {
		totalNew += item.new_patients;
		totalReturning += item.returning_patients;
	});

	patientPieChart.data.datasets[0].data = [totalNew, totalReturning];
	patientPieChart.update();
}
function exportExcel() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    let url = "/admin/admin-patient?export=1";
    if (startDate && endDate) {
        url += `&start=${startDate}&end=${endDate}`;
    }

    window.location.href = url;
}



	// const 
</script>


{%endblock%}