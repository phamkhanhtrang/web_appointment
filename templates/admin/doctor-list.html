{% load static %}
{% include "admin/dashboard.html" %}
{% block content %}

<div class="page-wrapper">
	<div class="content container-fluid">
		<div class="container py-4">
			<div class="sticky-header text-center fade-in">
				<h1 class="fw-bold mb-1" style="letter-spacing:1px;">ğŸ“Š Thá»‘ng kÃª BÃ¡c sÄ©</h1>
				<p class="text-muted mb-0">Tá»•ng quan hoáº¡t Ä‘á»™ng, lá»‹ch háº¹n cá»§a cÃ¡c bÃ¡c sÄ© trong há»‡ thá»‘ng.</p>
			</div>

			<!-- Cards tá»•ng quan -->
			<div class="row g-4 mb-4 fade-in">
				<div class="col-md-5">
					<div class="glass-card p-4 d-flex align-items-center">
						<span class="stat-icon"><i class="bi bi-person-badge"></i></span>
						<div>
							<div class="small text-muted">Tá»•ng sá»‘ bÃ¡c sÄ©</div>
							<div class="fs-3 fw-bold">{{admin_total_doctors}}</div>
						</div>
					</div>
				</div>
				<div class="col-md-5">
					<div class="glass-card p-4 d-flex align-items-center">
						<span class="stat-icon"><i class="bi bi-calendar-check"></i></span>
						<div>
							<div class="small text-muted">Tá»•ng lá»‹ch háº¹n</div>
							<div class="fs-3 fw-bold">{{admin_total_appointments}}</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Biá»ƒu Ä‘á»“ -->
			<div class="row g-4 mb-4 fade-in">
				<div class="col-md-10">
					<div class="chart-card">
						<h6 class="fw-bold mb-3">ğŸ“Š So sÃ¡nh lá»‹ch háº¹n theo bÃ¡c sÄ©</h6>
						<div class="d-flex mb-3">
							<input type="date" id="startDate" class="form-control me-2">
							<input type="date" id="endDate" class="form-control">
							<button class="bt btn-primary" onclick="filterChart()">Lá»c</button>
						</div>
						<canvas id="doctorBarChart" height="120"></canvas>
					</div>
				</div>
				<!-- <div class="col-md-6">
					<div class="chart-card">
						<h6 class="fw-bold mb-3">ğŸ“ˆ Lá»‹ch háº¹n theo ngÃ y</h6>

						<div class="d-flex mb-3">
							<input type="date" id="lineStartDate" class="form-control me-2">
							<input type="date" id="lineEndDate" class="form-control me-2">
							<button class="btn btn-primary" onclick="filterLineChart()">Lá»c</button>
						</div>
						<canvas id="appointmentLineChart" height="120"></canvas>
					</div>

				</div> -->
			</div>

			<!-- Báº£ng chi tiáº¿t -->
			<div class="chart-card mb-5 fade-in">
				<h6 class="fw-bold mb-3">ğŸ“‹ Thá»‘ng kÃª chi tiáº¿t tá»«ng bÃ¡c sÄ©</h6>
				<div class="table-responsive">
					<table class="table table-hover align-middle">
						<thead class="table-light">
							<tr>
								<th style="width:60px;">BÃ¡c sÄ©</th>
								<th>ChuyÃªn khÃ¡m</th>
								<th class="text-center">GiÃ¡ khÃ¡m bá»‡nh</th>
								<th class="text-center">SÄT</th>
								<th class="text-center">Lá»‹ch lÃ m viá»‡c</th>
								<th class="text-center">Thá»‘ng kÃª</th>
							</tr>
						</thead>
						<tbody>
							{% for list_doctor in admin_list_doctor %}
							<tr>
								<td>
									<img src="{{list_doctor.user.avatar.url}}" alt="avatar"
										class="rounded-circle me-2" width="36">
									<span class="fw-bold">BS.{{ list_doctor.user.get_full_name }}</span>
								</td>
								<td><span class="badge bg-primary">{{ list_doctor.specialization }}</span></td>
								<td class="text-center">{{list_doctor.price_vnd}}</td>
								<td class="text-center">{{ list_doctor.user.phone_number }}</td>
								<td class="text-center"><a href="admin-calendar/{{ list_doctor.user.username }}">Xem
										lá»‹ch</a></td>
								<td class="text-center">Xem thá»‘ng kÃª</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Floating Export Button -->
		<div class="fab" title="Xuáº¥t bÃ¡o cÃ¡o">
			<i class="bi bi-download"></i>
		</div>
	</div>
</div>
<script>
	// Biá»ƒu Ä‘á»“ cá»™t
	const appointmentData = JSON.parse('{{ admin_chart_data|escapejs }}');   // láº¥y tá»« Django context

	const barCtx = document.getElementById("doctorBarChart").getContext("2d");

	// Láº¥y danh sÃ¡ch bÃ¡c sÄ© duy nháº¥t
	const doctors = [...new Set(appointmentData.map(item => item.doctor))];

	let doctorChart = new Chart(barCtx, {
		type: "bar",
		data: {
			labels: doctors,
			datasets: [{
				label: "Sá»‘ lá»‹ch háº¹n",
				data: doctors.map(doc =>
					appointmentData.filter(item => item.doctor === doc)
						.reduce((sum, item) => sum + item.appointments, 0)
				),
				backgroundColor: ["#42a5f5", "#66bb6a", "#ffa726", "#ef5350"]
			}]
		},
		options: {
			responsive: true,
			scales: {
				y: { beginAtZero: true }
			}
		}
	});

	// Lá»c theo ngÃ y
	function filterChart() {
		const startDate = document.getElementById("startDate").value;
		const endDate = document.getElementById("endDate").value;

		if (!startDate || !endDate) {
			alert("Vui lÃ²ng chá»n cáº£ ngÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc.");
			return;
		}

		let counts = doctors.map(doc => {
			return appointmentData
				.filter(item => item.doctor === doc && item.day >= startDate && item.day <= endDate)
				.reduce((sum, item) => sum + item.appointments, 0);
		});

		doctorChart.data.datasets[0].data = counts;
		doctorChart.update();
	}
	document.querySelector('.fab').onclick = function () {
		alert('Chá»©c nÄƒng xuáº¥t bÃ¡o cÃ¡o sáº½ Ä‘Æ°á»£c phÃ¡t triá»ƒn!');
	};
</script>
{%endblock%}